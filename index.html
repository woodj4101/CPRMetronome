<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="CPR Metronome">
		<title>CPR Metronome</title>
		<link rel="stylesheet" type="text/css" href="https://unpkg.com/notie/dist/notie.min.css">
		<style>

			* {
				margin: 0;
				border: 0;
				padding: 0;
				box-sizing: border-box;
				text-align: center;
				font-family: 'Noto Sans KR', sans-serif;
				font-size: 5vw;
				font-weight: bold;
				user-select: none;
			}

			body, html {
				height: 100%;
				width: 100%;
				justify-content: center;
			}
			
			button {
			  height: 100%;
			  width: 100%;
				color: #000000;
				margin: 0;
				border: 0;
				padding: 0;
				font-weight: bold;
				cursor: pointer;
			}
			
			svg {
				width: min(50vw, 50vh);
				stroke: transparent;
				stroke-width: 0px;
			}
			
			#startBtn { background-color: #7cfc00; }
			
			#stopBtn { background-color: #d13a44; }
			
			.hidden { display: none; }
			
			.notie-container { box-shadow: none; }
			
		</style>
	</head>
	
	<body>
		<button id="startBtn">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="#556b2f"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>
		</button>
		<button id="stopBtn">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="#800000"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5"/></svg>
		</button>
		<script>

			const startBtn = document.getElementById("startBtn");
			const stopBtn = document.getElementById("stopBtn");
			
			stopBtn.classList.add("hidden");
			
			const bpm = 110;
			const beatInterval = 60 / bpm; // seconds

			const userLang = navigator.language || navigator.userLanguage; 
			
			const unmute = {
				"en": "Please disable silent mode",
				"ko": "무음 모드를 해제해 주세요",
				"zh": "请关闭静音模式",
				"ja": "サイレントモードを解除してください",
				"es": "Por favor, desactive el modo silencio",
				"fr": "Veuillez désactiver le mode silencieux",
				"de": "Bitte deaktivieren Sie den Stummmodus",
				"pt": "Por favor, desative o modo silencioso",
				"it": "Disattivi la modalità silenziosa, per favore",
				"ru": "Пожалуйста, отключите режим без звука",
				"ar": "يرجى تعطيل وضع الصامت",
				"hi": "कृपया साइलेंट मोड बंद करें",
				"bn": "নীরব মোড বন্ধ করুন",
				"tr": "Lütfen sessiz modu kapatınız",
				"vi": "Vui lòng tắt chế độ im lặng",
				"th": "กรุณาปิดโหมดเงียบ",
				"id": "Silakan nonaktifkan mode senyap",
				"pl": "Proszę wyłączyć tryb cichy",
				"nl": "Schakel alstublieft de stille modus uit",
				"sv": "Var vänlig inaktivera tyst läge"
			};

			const langCode = userLang.slice(0,2);
			const unmuteMsg = unmute[langCode] || unmute["en"];
			
			let audioCtx = null;
			
			let isRunning = false;
			let nextNoteTime = 0;
			let schedulerId = null;

			// 얼마나 앞까지 예약할지 (초)
			const scheduleAheadTime = 0.1;

			// JS가 얼마나 자주 깨어날지 (ms)
			const lookahead = 25;

			let wakeLock = null;

			async function requestWakeLock() {
				try {
					if ("wakeLock" in navigator) {
						wakeLock = await navigator.wakeLock.request("screen");
						console.log("Wake Lock acquired");
					} else {
						console.log("Wake Lock not supported");
					}
				} catch (err) {
					console.error("Wake Lock failed:", err);
				}
			}
			
			async function releaseWakeLock() {
				if (wakeLock) {
					await wakeLock.release();
					wakeLock = null;
					console.log("Wake Lock released");
				}
			}
			
			function updateBtn() {
				if (isRunning) {
					startBtn.classList.add("hidden");
					stopBtn.classList.remove("hidden");
				} else {
					startBtn.classList.remove("hidden");
					stopBtn.classList.add("hidden");
				}
			}
			
			function playClick(time) {
				const osc = audioCtx.createOscillator();
				const gain = audioCtx.createGain();

				osc.type = "square";
				osc.frequency.value = 1000;

				gain.gain.setValueAtTime(0.3, time);
				gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

				osc.connect(gain);
				gain.connect(audioCtx.destination);

				osc.start(time);
				osc.stop(time + 0.05);
			}

			function scheduler() {
				while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
					playClick(nextNoteTime);
					nextNoteTime += beatInterval;
				}
			}

			function startMetronome() {
				if (!audioCtx) {
					audioCtx = new (window.AudioContext || window.webkitAudioContext)();
				}
	
				if (audioCtx.state === "suspended") {
					audioCtx.resume();
				}

				if (isRunning) return;

				isRunning = true;
				nextNoteTime = audioCtx.currentTime + 0.05;

				schedulerId = setInterval(scheduler, lookahead);
				requestWakeLock();
				updateBtn();
			}

			function stopMetronome() {
				isRunning = false;
				clearInterval(schedulerId);
				schedulerId = null;
				releaseWakeLock();
				updateBtn();
			}
			
			startBtn.addEventListener("click", startMetronome);
			stopBtn.addEventListener("click", stopMetronome);
		document.addEventListener("visibilitychange", () => {
			  if (document.visibilityState === "visible" && isRunning) {
					requestWakeLock();
				}
				if (isRunning && audioCtx.state === "suspended") {
					isRunning = false;
					updateBtn();
				}
			});
			
		 window.addEventListener("load", () => {
				notie.alert({
					text: unmuteMsg,
					time: 5
				});
			});
		</script>
		<script src="https://unpkg.com/notie"></script>
	</body>
</html>
