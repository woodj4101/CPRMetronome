<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="CPR Metronome">
		<title>CPR Metronome</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.0/animate.min.css">
		
		<style>

			* {
				margin: 0;
				border: 0;
				padding: 0;
				box-sizing: border-box;
				text-align: center;
				font-family: 'Noto Sans KR', sans-serif;
				font-size: 5vw;
				font-weight: bold;
				color: black;
				user-select: none;
			}

			body, html {
				margin: 0;
				border: 0;
				padding: 0;
				height: 100%;
				width: 100%;
				justify-content: center;
			}
			
			button {
			  margin: 0;
				border: 0;
				padding: 0;
				height: 100%;
			  width: 100%;
				color: #000000;
				background-color: rgba(0, 0, 0, 0);
				font-weight: bold;
				cursor: pointer;
			}
			
			button:active {
				background-color: rgba(0, 0, 0, 0.15);
			}
			
			svg {
				stroke: transparent;
				stroke-width: 0px;
			}
			
			button svg {
				width: min(50vw, 50vh);
				fill: rgba(0, 0, 0, 0.4);
			}
			
			button:active svg {
				fill: rgba(0, 0, 0, 0.7);
			}
			
			#volumeIconSection {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			
			#volumeIconSection svg {
				width: min(30vw, 30vh);
			}
			
			#muteIcon {
				fill: lightcoral;
			}
			
			#unmuteIcon {
				fill: lightblue;
			}
			
			.startColor {
				background-color: #7cfc00;
			}
			
			.stopColor {
				background-color: #d13a44;
			}
			
			.hidden {
				display: none;
			}
			
			.notie-container {
				box-shadow: none;
			}
			
		</style>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	</head>
	
	<body id="background">
		<button id="startBtn">
			<svg id="startIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>
		</button>
		<button id="stopBtn">
			<svg id="stopIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5"/></svg>
		</button>
		<script>
			
			const background = document.getElementById("background");
			const startBtn = document.getElementById("startBtn");
			const stopBtn = document.getElementById("stopBtn");
						
			background.classList.toggle("startColor");
			stopBtn.classList.toggle("hidden");
			
			const bpm = 110;
			const beatInterval = 60 / bpm; // seconds

			const userLang = navigator.language || navigator.userLanguage; 
			
			const unmute = {
				"en": "Please disable silent mode",
				"ko": "무음 모드를 해제해 주세요",
				"zh": "请关闭静音模式",
				"ja": "サイレントモードを解除してください",
				"es": "Por favor, desactive el modo silencio",
				"fr": "Veuillez désactiver le mode silencieux",
				"de": "Bitte deaktivieren Sie den Stummmodus",
				"pt": "Por favor, desative o modo silencioso",
				"it": "Disattivi la modalità silenziosa, per favore",
				"ru": "Пожалуйста, отключите режим без звука",
				"ar": "يرجى تعطيل وضع الصامت",
				"hi": "कृपया साइलेंट मोड बंद करें",
				"bn": "নীরব মোড বন্ধ করুন",
				"tr": "Lütfen sessiz modu kapatınız",
				"vi": "Vui lòng tắt chế độ im lặng",
				"th": "กรุณาปิดโหมดเงียบ",
				"id": "Silakan nonaktifkan mode senyap",
				"pl": "Proszę wyłączyć tryb cichy",
				"nl": "Schakel alstublieft de stille modus uit",
				"sv": "Var vänlig inaktivera tyst läge"
			};

			const langCode = userLang.slice(0,2);
			const unmuteMsg = unmute[langCode] || unmute["en"];
			
			let audioCtx = null;
			
			let isRunning = false;
			let nextNoteTime = 0;
			let schedulerId = null;

			// 얼마나 앞까지 예약할지 (초)
			const scheduleAheadTime = 0.1;

			// JS가 얼마나 자주 깨어날지 (ms)
			const lookahead = 25;

			let wakeLock = null;

			async function requestWakeLock() {
				try {
					if ("wakeLock" in navigator) {
						wakeLock = await navigator.wakeLock.request("screen");
						console.log("Wake Lock acquired");
					} else {
						console.log("Wake Lock not supported");
					}
				} catch (err) {
					console.error("Wake Lock failed:", err);
				}
			}
			
			async function releaseWakeLock() {
				if (wakeLock) {
					await wakeLock.release();
					wakeLock = null;
					console.log("Wake Lock released");
				}
			}
			
			function updateBtn() {
				background.classList.toggle("startColor");
				background.classList.toggle("stopColor");
					startBtn.classList.toggle("hidden");
					stopBtn.classList.toggle("hidden");
			}
			
			function playClick(time) {
				const osc = audioCtx.createOscillator();
				const gain = audioCtx.createGain();

				osc.type = "square";
				osc.frequency.value = 1000;

				gain.gain.setValueAtTime(0.3, time);
				gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

				osc.connect(gain);
				gain.connect(audioCtx.destination);

				osc.start(time);
				osc.stop(time + 0.05);
			}

			function scheduler() {
				while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
					playClick(nextNoteTime);
					nextNoteTime += beatInterval;
				}
			}

			function startMetronome() {
				if (!audioCtx) {
					audioCtx = new (window.AudioContext || window.webkitAudioContext)();
				}
	
				if (audioCtx.state === "suspended") {
					audioCtx.resume();
				}

				if (isRunning) return;

				isRunning = true;
				nextNoteTime = audioCtx.currentTime + 0.05;

				schedulerId = setInterval(scheduler, lookahead);
				requestWakeLock();
				updateBtn();
			}

			function stopMetronome() {
				isRunning = false;
				clearInterval(schedulerId);
				schedulerId = null;
				releaseWakeLock();
				updateBtn();
			}
			
			startBtn.addEventListener("click", startMetronome);
			stopBtn.addEventListener("click", stopMetronome);
			document.addEventListener("visibilitychange", () => {
			  if (document.visibilityState === "visible" && isRunning) {
					requestWakeLock();
				}
			});
			
		 document.addEventListener("DOMContentLoaded", () => {
			 
			 let volumeIconInterval;
			 Swal.fire({
				html: `
					<div id="volumeIconSection">
				  <svg id="muteIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06m7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0"/></svg>
					<svg id="unmuteIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06"/></svg>
						</div><br><b>
				` + unmuteMsg + '</b>',
				showClass: {
					popup: `
					  animate__animated
						animate__fadeInUp
						animate__faster
					`
				},
				hideClass: {
					popup: `
					  animate__animated
						animate__fadeOutDown
						animate__faster
					`
				},
				didOpen: () => {
					let muteIcon = document.getElementById("muteIcon");
					let unmuteIcon = document.getElementById("unmuteIcon");
					unmuteIcon.classList.toggle("hidden");
					volumeIconInterval = setInterval(() => {
						muteIcon.classList.toggle("hidden"); unmuteIcon.classList.toggle("hidden");
					}, 1000);
				},
				willClose: () => {
					clearInterval(volumeIconInterval);
				},
				color: "#000000",
				heightAuto: false,
				scrollbarPadding: false,
				showCancelButton: false,
				showConfirmButton: false,
				timer: 6000
			});
		});
			
		</script>
		<script src="https://unpkg.com/notie"></script>
		</body>
</html>
